# Telegram Video Circle Bot

Бот для конвертации пересланных видео в видео-кружки (video notes) в Telegram. Берёт фрагмент с начала ролика (по умолчанию), кадрирует до квадрата и отправляет как кружок. Поддерживает сохранение оригинального звука и персональные настройки длительности и масштаба для каждого пользователя.

## Возможности
- Принимает видео как тип `video` или `document` (до FullHD вход).
- Берёт сегмент с начала ролика (по умолчанию 10 секунд, настраивается до 60).
- Кадрирует и масштабирует под квадратный формат кружка.
- Сохраняет оригинальный звук (перекодирует в AAC для совместимости). Если звука нет — добавляет немой трек.
- Персональные настройки на пользователя:
  - `/duration 1-60` — длительность кружка в секундах
  - `/scale 50-300` — масштаб изображения в процентах (100 — оригинал, 150 — увеличить, 75 — уменьшить)
- Оптимизированные параметры кодирования под Telegram: H.264, yuv420p, faststart, ограничение битрейтов.

## Требования
- Python 3.10+
- FFmpeg установлен в системе и доступен в PATH (должны работать команды `ffmpeg` и `ffprobe`).

Проверка установки FFmpeg:
```bash
ffmpeg -version
ffprobe -version
```

Установка FFmpeg:
- Windows: скачать сборку с https://www.gyan.dev/ffmpeg/builds/ и добавить `C:\ffmpeg\bin` в PATH.
- macOS: `brew install ffmpeg`
- Linux (Fedora): `sudo dnf install ffmpeg`
- Linux (Debian/Ubuntu): `sudo apt install ffmpeg`

## Установка и запуск

1) Клонируйте репозиторий
```bash
git clone https://github.com/Kxngfxsher/telegram-video-circle-bot.git
cd telegram-video-circle-bot
```

2) (Рекомендуется) создать виртуальное окружение
- Windows (PowerShell):
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```
- macOS/Linux:
```bash
python3 -m venv .venv
source .venv/bin/activate
```

3) Установите зависимости
```bash
pip install -r requirements.txt
```
Если возникают ошибки сборки `uvloop`/`cchardet`, можно временно установить только основные зависимости:
```bash
cat > requirements_simple.txt << EOF
python-telegram-bot==20.7
ffmpeg-python==0.2.0
python-dotenv==1.0.0
aiofiles==23.2.1
EOF
pip install -r requirements_simple.txt
```

4) Создайте файл `.env`
```bash
cp .env.example .env
```
Заполните `BOT_TOKEN` токеном бота из @BotFather. При необходимости отредактируйте параметры по умолчанию:
- `MAX_FILE_SIZE_MB` — максимальный размер входного файла
- `MAX_VIDEO_DURATION` — максимальная длительность входного видео
- `CIRCLE_DURATION` — базовая длительность кружка по умолчанию (можно менять командой /duration)
- `LOG_LEVEL` — уровень логирования

5) Запустите бота
```bash
python bot.py
```

## Использование
- Отправьте боту видео. Бот скачает файл, возьмёт фрагмент с начала нужной длительности, кадрирует до квадрата и отправит как кружок.

Команды:
- `/start` — краткая справка
- `/help` — помощь
- `/duration <1-60>` — установить длительность кружка в секундах для текущего пользователя
- `/duration` — показать текущую длительность
- `/scale <50-300>` — установить масштаб изображения в процентах для текущего пользователя
- `/scale` — показать текущий масштаб

Примеры:
```text
/duration 15   # 15 секунд
/scale 150     # увеличение на 50%
/scale 75      # уменьшение, больше области видно
```

## Технические детали
- Видео: `libx264`, `yuv420p`, `crf=23`, `preset=medium`, `maxrate=2500k`, `bufsize=5000k`, `movflags=+faststart`.
- Аудио: `aac`, `bitrate 128k`. Если в исходном видео нет аудио — добавляется немой аудиопоток для стабильной отправки в Telegram.
- Сегмент по умолчанию берётся с начала ролика. При обработке длительность подстраивается под ограничение (максимум 60 секунд).
- Масштабирование: настраиваемый зум через фильтры FFmpeg с промежуточным масштабом и итоговым crop до целевого размера.

## Структура проекта
```
telegram-video-circle-bot/
├─ bot.py               # Точка входа, команды (/duration, /scale), обработка видео-сообщений
├─ video_processor.py   # FFmpeg пайплайн: вырез с начала, scale/crop, звук, кодирование
├─ config.py            # Конфигурация, чтение .env, валидация
├─ requirements.txt     # Зависимости
├─ .env.example         # Пример настроек
├─ .gitignore           # Игнор-файлы
└─ temp/                # Временные файлы (создаётся автоматически)
```

## Диагностика
- Если бот не стартует с ошибкой NetworkError/ConnectError:
  - Проверь доступ к `https://api.telegram.org` в браузере
  - Отключи временно антивирус/прокси/HTTPS‑сканирование или задай корректные исключения
  - Убедись, что переменные окружения `HTTP_PROXY/HTTPS_PROXY` не мешают соединению
- Если конвертация падает:
  - Убедись, что `ffmpeg`/`ffprobe` доступны в PATH
  - Проверь логи: при ошибках FFmpeg выводит подробный stderr в лог

## Планируемые улучшения
- Сохранение пользовательских настроек в БД (SQLite), чтобы не терялись при перезапуске
- Docker/Docker Compose для удобного деплоя
- Webhook режим для продакшена

## Лицензия
MIT
